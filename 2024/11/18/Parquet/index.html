<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Parquet原理详解 | 孙氏杂货铺</title><meta name="keywords" content="parquet,文件存储"><meta name="author" content="孙杨洋"><meta name="copyright" content="孙杨洋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Parquet原理详解"><meta name="application-name" content="Parquet原理详解"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Parquet原理详解"><meta property="og:url" content="https://yangysun.github.io/blog/2024/11/18/Parquet/index.html"><meta property="og:site_name" content="孙氏杂货铺"><meta property="og:description" content="Apache Parquet 是一种高效的列式存储格式，其设计初衷是优化大规模数据处理的性能与存储效率。在大数据领域，随着数据规模的迅速增长，如何高效地存储、读取和处理数据已成为关键问题。作为 Apache 软件基金会支持的开源项目，Parquet 凭借卓越的数据压缩率和快速查询能力，被广泛应用于各"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://yangysun.github.io/blog/images/cover_image/parquet.jpg"><meta property="article:author" content="孙杨洋"><meta property="article:tag" content="时空"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://yangysun.github.io/blog/images/cover_image/parquet.jpg"><meta name="description" content="Apache Parquet 是一种高效的列式存储格式，其设计初衷是优化大规模数据处理的性能与存储效率。在大数据领域，随着数据规模的迅速增长，如何高效地存储、读取和处理数据已成为关键问题。作为 Apache 软件基金会支持的开源项目，Parquet 凭借卓越的数据压缩率和快速查询能力，被广泛应用于各"><link rel="shortcut icon" href="/blog/favicon.ico"><link rel="canonical" href="https://yangysun.github.io/blog/2024/11/18/Parquet/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/blog/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 编程与技术探索者","🧑‍💻 高效数据处理专家","🏗️ 分布式系统与数据库开发达人","🌐 实时数据流与批处理一体化设计师","🛠️ 高效工具与框架构建者","🔍 深入探索计算机科学与技术的研究者","💡 创新型问题解决者","🚀 团队协作与项目管理能手"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 孙杨洋","link":"链接: ","source":"来源: 孙氏杂货铺","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '孙氏杂货铺',
  title: 'Parquet原理详解',
  postAI: '',
  pageFillDescription: '1. 基础概念, 1.1 列式存储 VS 行式存储, 2. Parquet详解, 2.1 数据模型, 2.2 列式存储格式, 2.3 Repetition and Definition Levels, 2.3.1 Repetition Levels, 2.3.2 Definition Levels, 2.3.3 计算过程, 2.3.4 存储分析, 2.4 编码与压缩技术, 2.4.1 编码, 2.4.2 压缩, 3. Parquet具体实现, 3.1 Parquet 文件存储格式中的术语, 3.2 并行化执行的基本单元, 3.3 Parquet 文件格式, 3.4 元数据信息, 3.5 并行读取与列存储的优化, 3.6 编码（Encoding）, 3.7 Column Chunks 存储与读取, 3.8 错误处理机制, 3.9 推荐的配置参数, 4. Python使用Parquet, 4.1 安装依赖并导入, 4.2 定义schema, 4.3 导入数据, 4.4 生成parquet文件, 4.4读取parquet文件并且查看格式信息, 4.4.1 读取parquet文件, 4.4.2 查看schameamp元信息, 4.4.3 查看列信息, 4.4.4 查看列编码方式, 5. 总结是一种高效的列式存储格式其设计初衷是优化大规模数据处理的性能与存储效率在大数据领域随着数据规模的迅速增长如何高效地存储读取和处理数据已成为关键问题作为软件基金会支持的开源项目凭借卓越的数据压缩率和快速查询能力被广泛应用于各类大数据处理场景本文旨在从理论与实践的双重视角系统分析的设计理念核心架构与技术实现特别是其在处理复杂嵌套数据结构方面的独特优势期望为研究者和开发者提供深入的理解与指导基础概念列式存储行式存储行式存储行式存储是将一行数据的所有字段连续存储在一起例如对于下表中的数据在行式存储中数据会按照以下方式存储每一行的数据被紧密地存储在一起这样的存储方式便于对单行数据的增删改查操作在行式存储模式下整行数据的存取非常高效尤其是在需要获取或修改完整的一行数据时能够显著提高访问效率行式存储的优点快速定位整行数据行式存储能够快速定位到某一行的数据例如当查询的数据时只需从存储中直接读取这一行所有字段都能一次性高效返回事务操作支持好行式存储非常适合高频的增删改操作例如修改这一行的值这种操作只需要定位到该行并进行更新整体效率非常高如果需要查询或更新的所有数据行式存储可以快速定位到这一整行数据并进行操作而无需访问其他数据因而效率非常高行式存储特别适合在线事务处理场景电商系统银行系统等需要频繁处理单条记录的增删改操作的应用中行式存储表现尤为出色列式存储与行式存储不同列式存储将同一列的数据连续存储在一起对于上面的示例表格列式存储方式如下在这种存储模式下每列的数据在物理存储中是连续存放的列与列之间的数据相互独立列式存储更适合对某些列进行查询例如在大数据分析中仅需要查询和而无需加载其他字段列式存储的优点按列查询性能高在数据分析场景中查询操作往往只涉及少数列例如筛选接近的数据在列式存储中只需读取列即可这显著减少了操作和内存占用提高了查询效率压缩效果好由于同一列的数据类型相同且分布相似列式存储能够实现高效压缩例如列的值有一定规律性这样的数据在列式存储中可以被压缩得非常紧凑从而节省存储空间并加速处理如果需要查找所有记录的列式存储只需要读取这一列的数据跳过其他列的数据减少了读取不必要数据的开销这对于大规模数据分析非常高效列式存储非常适合在线分析处理场景尤其在数据仓库大规模数据分析等需要对大量数据进行聚合过滤和统计计算的应用中列式存储能够显著提高查询效率详解数据模型采用了一个类似的协议来描述存储数据的以下面这个为例介绍的数据模型在这个中每条记录代表一条轨迹每条记录中有且仅有一个每个可以对应个或多个和每个必须包含一个字段则为可选字段每个必须包含唯一的和在的顶层是它可以包含多个字段每个字段具有三个属性重复性类型和名字字段的重复性包含三种有且只有一次次或次次或多次字段的类型包括基础数据类型物理上只存储基础数据类型逻辑数据类型指导如何转换成基础数据类型进行存储字符串类型数字类型有符号整数无符号整数十进制时间类型嵌入类型嵌套类型需要三级嵌套需要三级嵌套空值可以用来表示格式可以用包含对且是的来表示格式列式存储格式在格式的存储中一个的树结构有几个叶子节点叶子节点都是基础数据类型实际的存储中就会有多少上面的的树结构如图所示这个实际存储列如表所示文件采用按列存储的方式但面对复杂的嵌套结构时由于嵌套和重复的位置难以确定恢复原始嵌套结构变得具有一定挑战性为了解决这一问题使用了算法通过为每条数据增加和实现对嵌套结构的精准还原得益于这种设计任意字段的恢复无需依赖其他字段同时还支持按照原始嵌套格式对任意字段子集进行重建大大提升了数据解析的灵活性与效率以下面表格中的数据为例用于表示当前值在路径中的重复层级即该值位于哪个重复字段的结构中专门用来处理重复字段以和为例字段是一个列表类型字段包含值每个值的分别为和是列表的第一个值即列表的起点因此它的为后续的值和都属于同一个列表表示列表的后续元素因此它们的为字段是一个类型其键为时间戳值为包含经纬度的结构体对于每个键值对第一个键值对时间戳为这是的第一个值因此为第二个键值对时间戳为这是同一个中的第二个值因此它的为表示的重复部分虽然纬度和经度的值为空这些字段的依然为空值的状态不会影响而是通过来表示表示路径上有多少可选字段被定义嵌套数据类型的一个特点是某些字段例如可选字段或重复字段可以为空或者未被定义如果一个字段被定义了那么它的所有父节点也都必须是已定义的从根节点开始遍历当某个字段的路径上某个节点为空时我们记录当前的深度作为该字段的如果某字段的达到了它的最大值就说明该字段是有数据的对于必须字段如类型字段始终是定义的因此不需要特别标明而对于可选字段如类型用于区分字段是未定义为空还是有值在关系型数据中为表示字段未定义或更高表示字段已定义并可能有值在字段中是一个列表字段其元素是可选的当列表中某个元素有值时例如它的为表示该元素被定义且有数据如果列表为空为表示未被定义在字段中是一个类型字段键为时间戳值为嵌套的纬度和经度字段当时间戳键值对中纬度和经度都有值时例如和为表示字段完全定义且有值如果某个时间戳的纬度和经度值为空例如为的键值对会降为表示字段已定义但没有数据如果整个字段为空为表示字段未被定义计算过程以下是第一条和第二条数据的和的计算过程整合对于第一条数据是标量字段没有嵌套或重复固定为固定为表示字段始终定义并有值是一个列表第一个元素表示列表的起点因此后续的和属于同一列表因此表明字段存在且有值是的键第一个键值对是的起点表明键和值都定义且非空第二个键值对是中的后续键值对表明键已定义但值为空和是值中的嵌套字段对应的纬度和经度都存在由于是字段与上一层保持相同因此的纬度和经度为空表示字段已定义但无值对于第二条数据是标量字段与第一条类似固定为固定为是一个列表第一个元素表示列表的起点因此后续的属于同一列表因此表明字段存在且有值是的键只有一个键值对因此表明键和值都定义且非空和是值中的嵌套字段对应的纬度和经度都存在因此表示字段已定义且有值存储分析在中所有字段会被展平为单独的列每列存储其实际数据同时附加和两列来记录层级结构和字段状态并不存储值而是通过的值来判断字段是否被定义例如小于最大值时表示字段为空对于嵌套字段和重复字段如和的值则用于区分新记录与同一结构中的后续值这种设计的优点在于它可以在保持数据层级关系的同时避免存储冗余的层级结构信息同时由于和只需要几位就可以表示字段的状态如层结构只需要就能表示和存储开销极小空字段无需存储实际值仅通过和即可高效表示这种机制使得格式在处理嵌套数据时既保持了灵活性又显著提升了存储和读取效率编码与压缩技术编码编码是将数据转换为更紧凑的格式以减少存储空间或提高计算效率使用了几种常见的编码方式来对数据进行编码这些编码方式有助于在存储时减少数据的冗余提高读取性能编码编码是中最基础的编码方式它将原始数据直接存储没有进行任何压缩或变换该编码方式简单且高效适用于数据分布均匀的场景但可能会占用较多存储空间编码通常用于存储不需要特别优化的字段数据如简单的整数或字符串编码编码是一种通过使用字典映射表将数据中的重复值替换为字典索引的编码方式该编码方法适用于有大量重复值的数据类型比如类别型数据在中数据被分成多个区块每个区块都会为该区块内的数据生成一个字典存储时数据中的重复项会被替换为字典的索引进而节省存储空间例如如果一个字段中有多个相同的值那么这些值将被映射为字典的索引存储时只需保存索引而不是重复的值这种方法能够显著降低存储空间但需要为每个数据块生成字典可能会增加读取时的解码开销编码编码是通过记录连续相同值的数量来压缩数据的一种方式在数据中若出现连续相同的值会记录这些值出现的次数从而将重复的数据压缩成更小的表示形式编码特别适用于数据中存在大量连续相同值的情况例如如果一个字段连续出现个相同的数字那么会将其压缩为值出现次数的形式在中编码常用于布尔类型数据或者重复出现的数字类型数据位打包编码位打包是一种将多个小数据类型压缩为更小比特数表示的编码方式该方法通过打包多个值来提高存储效率通常用于存储较小的数据类型如整数布尔值等可以将每个字段中的数据值压缩为最小的比特位数从而减少存储空间编码编码是一种记录数据与其前一个值差异的编码方式这种方法非常适合存储数值范围比较小且增减变化不大的数据例如对于一个增长规律较为平稳的数字序列编码将存储每个数值与前一个数值的差异而不是存储完整的数值这样可以显著降低存储空间特别是对于时间序列数据或连续数据压缩压缩是将数据进一步减少存储空间的技术支持多种压缩算法可以在不牺牲数据质量的情况下进一步压缩数据以节省存储空间常见的压缩算法包括等压缩是开发的一种压缩算法具有非常快的压缩和解压缩速度它的压缩比虽然不如但由于其高效的速度特别适合大数据处理场景中实时数据处理的需求通常是默认的压缩算法尤其适用于对速度要求较高的场景压缩是一种较为常见的压缩算法相较于它的压缩比更高但速度较慢压缩适用于对存储空间有较高要求的场景尤其是当存储成本较高或数据量特别大的时候的高压缩比使得它能有效减少存储需求但解压缩的速度可能成为瓶颈压缩是一种快速的压缩算法类似于适用于需要快速压缩和解压缩的场景的压缩比一般不如但它的速度非常快适合于大数据分析中对压缩速度要求较高的应用场景压缩是由开发的一种压缩算法常用于数据传输中的压缩的压缩比比更高并且其解压速度也较为高效近年来也开始在中被使用尤其适用于对存储需求有较高要求的场景压缩是一种新兴的压缩算法旨在提供比更高的压缩比和更快的解压速度兼具了较高的压缩效率和较低的延迟非常适合需要平衡存储与速度的应用场景具体实现文件存储格式中的术语在理解文件的存储结构时熟悉其中关键术语至关重要以下是中一些核心术语的定义块这是分布式文件系统中数据存储的基本单元文件完全兼容的设计的大小在版本中默认为而在版本中则增加至使用的副本机制来确保数据的冗余和容错能力从而提高了系统的可靠性和稳定性文件这是存储在上的一个逻辑实体包含文件的元数据信息但其实际数据内容由多个保存行组将数据按行划分为多个逻辑上的水平分区每个包含该组中所有列的列块是并行化和操作的基本单元这样设计使得每个行组都可以独立解码便于分布式处理列块指单列数据在一个行组中的物理存储列块在行组中是逻辑连续的这种设计允许对列进行有效的压缩和编码从而提高了存储的利用率页面列块被进一步划分为多个这是文件压缩和编码的最小基本单元每个列块中可能包含多个类型的例如数据页面字典页面等并行化执行的基本单元在文件中不同层级的数据单元在并行化处理和操作中发挥不同的作用任务划分在使用的框架处理数据时通常以或为基本单位来分配任务即每个任务处理一个完整的文件或者一个行组从而实现并行化操作文件的操作以为基本单位进行这种设计方式使得可以只读取所需列的数据减少不必要的磁盘从而提高读取效率编码和压缩在中编码和压缩通常以为单位进行每个页面可以使用不同的编码方法来提高压缩率例如使用对重复值进行压缩从而降低存储空间文件格式文件格式具有自解析的特性文件使用格式定义以及其他元数据信息这些元数据信息存储在文件末尾方便读取时直接访问典型的文件结构如下整个文件被划分为多个行组每个行组包含所有列的数据块和元数据信息文件的元数据存储在数据部分的最后包含了所有列块元数据的起始位置这种将元数据存储在文件末尾的设计使得在写入数据时可以顺序高效地写入文件同时在读取文件时可以快速获取元数据并定位到相关数据块元数据信息文件包含三种不同类型的元数据每种元数据在不同层级描述文件的内容和结构文件元数据描述整个文件的结构和内容例如行组和列块的位置信息等是文件级别的数据概览列块元数据描述单个列块的详细信息包括该列块的属性位置和大小这些元数据使得读取特定列块变得更加高效页面头部元数据描述每个页面的具体属性包括编码方式压缩方法页面位置等这些元数据对于解码和读取页面中的数据至关重要并行读取与列存储的优化的设计充分考虑了并行处理和列存储的优势由于数据是按列存储的因此可以非常高效地进行列的读取操作尤其是对于只需要部分列的查询能够显著减少开销提升性能每个行组中的列块在物理上保持连续存储这样即使是大规模并行读取也可以最大程度减少磁盘寻道时间编码支持多种编码方式以优化数据的压缩和读取效率细节可以参考官方文档通过采用不同的编码方法能够大幅度减少重复值存储从而节省磁盘空间存储与读取每个是由多个组成的在读取数据时可以利用页面头部元数据中存储的信息直接跳过不感兴趣的页面例如字典页面与数据页面存储的内容类型不同可以根据需求决定是否需要加载某些页面从而优化查询性能错误处理机制文件设计了一系列机制来应对数据损坏的情况以保证数据的可用性和可靠性文件元数据损坏如果整个文件的元数据损坏通常情况下整个文件会无法读取列元数据损坏如果某个列的元数据损坏只会影响该列块的读取其他行组中相同列的块仍可正常使用这种设计能够减少局部损坏对整体数据的影响页面头部损坏当页面头部损坏时该列块中的所有后续页面将无法读取页面数据损坏如果某个页面的数据损坏通常只会导致该页面的数据不可用其它页面的数据仍然可用较小的行组设置可以更好地抵抗数据损坏因为损坏只会影响较小的数据范围而不会影响整个文件推荐的配置参数为了实现最佳的性能和可靠性提供了一些推荐配置行组大小较大的行组可以使列块变得更大进而提升顺序的性能虽然较大的行组需要更多的内存缓存但它能够有效减少操作次数从而提升性能推荐的行组大小为至此外行组最好与的大小对齐以减少跨的操作理想的配置是行组大小和大小均为并保证每个文件对应一个数据页大小数据页是不可分割的存储单元较小的数据页允许更精细的随机访问如单行查找但会增加的数量从而带来空间开销较大的数据页可以降低页面头部的开销提升数据解析的效率推荐的数据页大小为以在性能与空间利用率之间取得平衡总结来看文件格式通过行组列块页面三级结构结合丰富的元数据信息和多种编码方式达到了高效的数据存储和读取性能其列式存储特性使得数据的压缩率大幅提高并能高效支持大规模的并行查询对于需要处理海量数据的场景是一种高效而可靠的数据存储格式使用安装依赖并导入定义导入数据生成文件读取文件并且查看格式信息读取文件查看元信息元信息元信息查看列信息列信息总值数量压缩大小字节未压缩大小字节最大值无统计信息最小值无统计信息空值数量无统计信息列信息总值数量压缩大小字节未压缩大小字节最大值最小值空值数量列信息总值数量压缩大小字节未压缩大小字节最大值最小值空值数量列信息总值数量压缩大小字节未压缩大小字节最大值最小值空值数量列信息总值数量压缩大小字节未压缩大小字节最大值最小值空值数量列信息总值数量压缩大小字节未压缩大小字节最大值最小值空值数量查看列编码方式列编码方式列编码方式列编码方式列编码方式列编码方式列编码方式总结本文详细介绍了格式的原理与实践重点讲解了其列式存储结构嵌套数据支持编码与压缩技术以及如何在中使用文件的设计充分利用了列式存储的优势特别是在大数据分析场景中它能够显著提高查询效率并有效节省存储空间列式存储优势的列式存储方式使得在进行数据分析时可以只读取所需的列减少了不必要的磁盘操作此外列式存储能高效地压缩数据特别是对于重复性高的数据能够显著减少存储空间的占用复杂嵌套结构支持通过使用和能够高效处理复杂的嵌套数据结构例如和这种设计让格式在处理包含多个嵌套字段的复杂数据时保持高效且灵活编码与压缩技术支持多种编码方式如编码等和压缩算法如等这些技术帮助优化存储空间并提升数据读取性能在不同的场景下用户可以选择适合的编码和压缩方法以平衡存储与速度的需求使用通过库用户能够轻松地创建读取和操作文件示例代码展示了如何定义文件的将数据导入并生成文件以及如何读取文件并查看其元数据和编码信息性能优化的设计考虑了并行处理支持高效的列读取操作这对于大规模数据处理非常重要它通过将数据划分为行组列块和页面使得分布式计算框架如和能够高效地处理数据总的来说是一种功能强大的数据存储格式它结合了列式存储的优势与高效的压缩编码技术特别适合用于大数据分析和大规模分布式计算环境中',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-25 11:12:21',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/blog/49890814.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="1"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="1"/><span class="back-menu-item-text">1</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="2"><img class="back-menu-item-icon" src="https://image.anheyu.com/favicon.ico" alt="2"/><span class="back-menu-item-text">2</span></a></div></div></div></div><a id="site-name" href="/blog/" accesskey="h"><div class="title">孙氏杂货铺</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/blog/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/blog/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/blog/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/blog/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/blog/tags/Python/" style="font-size: 1.05rem;">Python<sup>1</sup></a><a href="/blog/tags/parquet/" style="font-size: 1.05rem;">parquet<sup>1</sup></a><a href="/blog/tags/%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/" style="font-size: 1.05rem;">文件存储<sup>1</sup></a><a href="/blog/tags/%E8%B7%AF%E7%BD%91/" style="font-size: 1.05rem;">路网<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/blog/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url">大数据</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/blog/tags/parquet/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>parquet</span></a><a class="article-meta__tags" href="/blog/tags/%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>文件存储</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Parquet原理详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-11-18T10:26:54.000Z" title="发表于 2024-11-18 10:26:54">2024-11-18</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-11-25T11:12:21.851Z" title="更新于 2024-11-25 11:12:21">2024-11-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">8.2k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="Parquet原理详解"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span class="waline-pageview-count" data-path="/blog/2024/11/18/Parquet/" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为重庆"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>重庆</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/blog/images/cover_image/parquet.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://yangysun.github.io/blog/2024/11/18/Parquet/"><header><a class="post-meta-categories" href="/blog/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url">大数据</a><a href="/blog/tags/parquet/" tabindex="-1" itemprop="url">parquet</a><a href="/blog/tags/%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/" tabindex="-1" itemprop="url">文件存储</a><h1 id="CrawlerTitle" itemprop="name headline">Parquet原理详解</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">孙杨洋</span><time itemprop="dateCreated datePublished" datetime="2024-11-18T10:26:54.000Z" title="发表于 2024-11-18 10:26:54">2024-11-18</time><time itemprop="dateCreated datePublished" datetime="2024-11-25T11:12:21.851Z" title="更新于 2024-11-25 11:12:21">2024-11-25</time></header><p>Apache Parquet 是一种高效的列式存储格式，其设计初衷是优化大规模数据处理的性能与存储效率。在大数据领域，随着数据规模的迅速增长，如何高效地存储、读取和处理数据已成为关键问题。作为 Apache 软件基金会支持的开源项目，Parquet 凭借卓越的数据压缩率和快速查询能力，被广泛应用于各类大数据处理场景。本文旨在从理论与实践的双重视角，系统分析 Apache Parquet 的设计理念、核心架构与技术实现，特别是其在处理复杂嵌套数据结构方面的独特优势，期望为研究者和开发者提供深入的理解与指导。</p>
<hr>
<h1 id="1-基础概念"><a href="#1-基础概念" class="headerlink" title="1. 基础概念"></a>1. 基础概念</h1><h2 id="1-1-列式存储-VS-行式存储"><a href="#1-1-列式存储-VS-行式存储" class="headerlink" title="1.1 列式存储 VS 行式存储"></a>1.1 列式存储 VS 行式存储</h2><p><strong>行式存储</strong>：行式存储是将一行数据的所有字段连续存储在一起。例如，对于下表中的数据：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>latitude</th>
<th>longitude</th>
<th>timestamp</th>
</tr>
</thead>
<tbody><tr>
<td>23</td>
<td>106.551556</td>
<td>29.563761</td>
<td>1732118400</td>
</tr>
<tr>
<td>46</td>
<td>106.480989</td>
<td>29.600298</td>
<td>1732161600</td>
</tr>
<tr>
<td>99</td>
<td>106.512051</td>
<td>29.583541</td>
<td>1732183200</td>
</tr>
</tbody></table>
<p>在行式存储中，数据会按照以下方式存储：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">23, 106.551556, 29.563761, 1732118400</span><br><span class="line">46, 106.480989, 29.600298, 1732161600</span><br><span class="line">99, 106.512051, 29.583541, 1732183200</span><br></pre></td></tr></table></figure>

<p>每一行的数据被紧密地存储在一起，这样的存储方式便于对单行数据的增、删、改、查操作。 在行式存储模式下，整行数据的存取非常高效，尤其是在需要获取或修改完整的一行数据时，能够显著提高访问效率。行式存储的优点：</p>
<ol>
<li><strong>快速定位整行数据</strong>：行式存储能够快速定位到某一行的数据。例如，当查询id&#x3D;46的数据时，只需从存储中直接读取这一行，所有字段都能一次性高效返回。</li>
<li><strong>事务操作支持好</strong>：行式存储非常适合高频的增删改操作，例如修改id&#x3D;23这一行的timestamp值。这种操作只需要定位到该行并进行更新，整体效率非常高。</li>
</ol>
<p>如果需要查询或更新id&#x3D;46的所有数据，行式存储可以快速定位到”46, 106.480989, 29.600298, 1732161600”这一整行数据，并进行操作，而无需访问其他数据，因而效率非常高。行式存储特别适合 OLTP（在线事务处理）场景，电商系统、银行系统等需要频繁处理单条记录的增删改操作的应用中，行式存储表现尤为出色。</p>
<p><strong>列式存储</strong>：与行式存储不同，列式存储将同一列的数据连续存储在一起。对于上面的示例表格，列式存储方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id:        23, 46, 99</span><br><span class="line">latitude:  106.551556, 106.480989, 106.512051</span><br><span class="line">longitude: 29.563761, 29.600298, 29.583541</span><br><span class="line">timestamp: 1732118400, 1732161600, 1732183200</span><br></pre></td></tr></table></figure>

<p>在这种存储模式下，每列的数据在物理存储中是连续存放的，列与列之间的数据相互独立。列式存储更适合对某些列进行查询，例如在大数据分析中仅需要查询latitude和longitude，而无需加载其他字段。列式存储的优点：</p>
<ol>
<li><strong>按列查询性能高</strong>：在数据分析场景中，查询操作往往只涉及少数列，例如筛选latitude接近106.5的数据。在列式存储中，只需读取 latitude列即可，这显著减少了 I&#x2F;O 操作和内存占用，提高了查询效率。</li>
<li><strong>压缩效果好</strong>：由于同一列的数据类型相同且分布相似，列式存储能够实现高效压缩。例如，timestamp列的值有一定规律性，这样的数据在列式存储中可以被压缩得非常紧凑，从而节省存储空间并加速处理。</li>
</ol>
<p>如果需要查找所有记录的latitude，列式存储只需要读取106.551556, 106.480989, 106.512051这一列的数据，跳过其他列的数据，减少了读取不必要数据的开销，这对于大规模数据分析非常高效。 列式存储非常适合OLAP（在线分析处理）场景，尤其在数据仓库、大规模数据分析等需要对大量数据进行聚合、过滤和统计计算的应用中，列式存储能够显著提高查询效率。</p>
<h1 id="2-Parquet详解"><a href="#2-Parquet详解" class="headerlink" title="2. Parquet详解"></a>2. Parquet详解</h1><h2 id="2-1-数据模型"><a href="#2-1-数据模型" class="headerlink" title="2.1 数据模型"></a>2.1 数据模型</h2><p>Parquet采用了一个类似Google Protobuf的协议来描述存储数据的schema，以下面这个schema为例介绍Parquet的数据模型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">message SpatialTemporalData &#123;</span><br><span class="line">  required int32 id;</span><br><span class="line">  repeated double speeds;</span><br><span class="line">  repeated group trajectory &#123;</span><br><span class="line">    required timestamp timestamp;</span><br><span class="line">    optional group location &#123;</span><br><span class="line">      required double latitude;  </span><br><span class="line">      required double longitude; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个schema中，每条记录代表一条轨迹。每条记录中有且仅有一个id，每个id可以对应0个或多个speeds和trajectory。每个trajectory必须包含一个timestamp，location字段则为可选字段。每个location必须包含唯一的latitude和longitude。在 schema的顶层是message，它可以包含多个字段。每个字段具有三个属性：<strong>重复性</strong>（repetition）、<strong>类型</strong>（type）和 <strong>名字</strong>（name）。</p>
<p>字段的重复性包含三种：</p>
<ul>
<li>required：有且只有一次</li>
<li>optional：0次或1次</li>
<li>repeated：0次或多次</li>
</ul>
<p>字段的类型包括：</p>
<ul>
<li>基础数据类型（物理上只存储基础数据类型）：BOOLEAN、INT32、INT64、INT96、FLOAT、DOUBLE、BYTE_ARRAY、FIXED_LEN_BYTE_ARRAY</li>
<li>逻辑数据类型（指导如何转换成基础数据类型进行存储）：<ul>
<li>字符串类型：STRING、ENUM、UUID</li>
<li>数字类型：有符号整数，无符号整数 INT(8&#x2F;16&#x2F;32&#x2F;64, true&#x2F;false)</li>
<li>十进制：DECIMAL</li>
<li>时间类型：DATE、TIME、TIMESTAMP</li>
<li>嵌入类型：JSON、BSON、VARIANT</li>
<li>嵌套类型：LIST（需要三级嵌套），MAP(需要三级嵌套)</li>
<li>空值</li>
</ul>
</li>
</ul>
<p>LIST可以用repeated field来表示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">repeated double speeds;</span><br><span class="line">=========================================================&gt;(parquet格式)</span><br><span class="line">optional group field_id=-1 speeds (List) &#123;</span><br><span class="line">    repeated group field_id=-1 list &#123;</span><br><span class="line">      optional double field_id=-1 element;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Map可以用包含key-value对且key是required的repeated group来表示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">repeated group trajectory &#123;</span><br><span class="line">    required timestamp timestamp;</span><br><span class="line">    optional group location &#123;</span><br><span class="line">      required double latitude;  </span><br><span class="line">      required double longitude; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">=========================================================&gt;(parquet格式)</span><br><span class="line">optional group field_id=-1 trajectory (Map) &#123;</span><br><span class="line">    repeated group field_id=-1 key_value &#123;</span><br><span class="line">      required int64 field_id=-1 key (Timestamp);</span><br><span class="line">      optional group field_id=-1 value &#123;</span><br><span class="line">        optional double field_id=-1 latitude;</span><br><span class="line">        optional double field_id=-1 longitude;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-列式存储格式"><a href="#2-2-列式存储格式" class="headerlink" title="2.2 列式存储格式"></a>2.2 列式存储格式</h2><p>在Parquet格式的存储中，一个schema的树结构有几个叶子节点（叶子节点都是基础数据类型），实际的存储中就会有多少column。 上面SpatialTemporalData的schema的树结构如图所示：</p>
<div style="text-align: center;">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/images/schema.png" style="width:66%;"/>
</div>

<p>这个schema实际存储5列，如表所示:</p>
<table>
<thead>
<tr>
<th>Column</th>
<th>Type</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INT32</td>
</tr>
<tr>
<td>speeds</td>
<td>DOUBLE</td>
</tr>
<tr>
<td>timestamp</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>latitude</td>
<td>DOUBLE</td>
</tr>
<tr>
<td>longitude</td>
<td>DOUBLE</td>
</tr>
</tbody></table>
<h2 id="2-3-Repetition-and-Definition-Levels"><a href="#2-3-Repetition-and-Definition-Levels" class="headerlink" title="2.3 Repetition and Definition Levels"></a>2.3 Repetition and Definition Levels</h2><p>Parquet文件采用按列存储的方式，但面对复杂的嵌套结构时，由于嵌套和重复的位置难以确定，恢复原始嵌套结构变得具有一定挑战性。为了解决这一问题，Parquet使用了 <strong>striping and assembly</strong> 算法，通过为每条数据增加 <strong>Repetition Levels</strong> 和 <strong>Definition Levels</strong>，实现对嵌套结构的精准还原。得益于这种设计，任意字段的恢复无需依赖其他字段，同时还支持按照原始嵌套格式对任意字段子集进行重建，大大提升了数据解析的灵活性与效率。以下面表格中的数据为例：</p>
<table>
<thead>
<tr>
<th><strong>id</strong></th>
<th><strong>speeds</strong></th>
<th><strong>trajectory.timestamp</strong></th>
<th><strong>trajectory.latitude</strong></th>
<th><strong>trajectory.longitude</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>[12.5, 13.2, 14.1]</td>
<td>2024-11-21 10:00:00</td>
<td>40.7128</td>
<td>-74.0060</td>
</tr>
<tr>
<td></td>
<td></td>
<td>2024-11-21 10:05:00</td>
<td>NULL</td>
<td>NULL</td>
</tr>
<tr>
<td>2</td>
<td>[20.1, 21.3]</td>
<td>2024-11-21 11:00:00</td>
<td>34.0522</td>
<td>-118.2437</td>
</tr>
</tbody></table>
<h3 id="2-3-1-Repetition-Levels"><a href="#2-3-1-Repetition-Levels" class="headerlink" title="2.3.1 Repetition Levels"></a>2.3.1 Repetition Levels</h3><p><strong>Repetition Level</strong> 用于表示当前值在路径中的重复层级，即该值位于哪个重复字段的结构中。 Repetition Level 专门用来处理重复字段。以 speeds 和 trajectory 为例：</p>
<ol>
<li><p><strong>speeds 字段</strong><br>speeds 是一个列表类型字段，包含值 [12.5, 13.2, 14.1]。每个值的 Repetition Level 分别为 0、1 和 1：</p>
<ul>
<li>12.5 是列表的第一个值（即列表的起点），因此它的 Repetition Level 为 0。</li>
<li>后续的值 13.2 和 14.1 都属于同一个列表，表示列表的后续元素，因此它们的 Repetition Level 为 1。</li>
</ul>
</li>
<li><p><strong>trajectory 字段</strong><br>trajectory 是一个 Map 类型，其键为时间戳，值为包含经纬度的结构体。对于每个 Map 键值对：</p>
<ul>
<li>第一个键值对（时间戳为 2024-11-21 10:00:00）：这是 Map 的第一个值，因此 Repetition Level 为 0。</li>
<li>第二个键值对（时间戳为 2024-11-21 10:05:00）：这是同一个 Map 中的第二个值，因此它的 Repetition Level 为 1，表示 Map 的重复部分。虽然纬度和经度的值为空，这些字段的 Repetition Level 依然为 1。</li>
<li>空值的状态不会影响 Repetition Level，而是通过 Definition Level 来表示。</li>
</ul>
</li>
</ol>
<h3 id="2-3-2-Definition-Levels"><a href="#2-3-2-Definition-Levels" class="headerlink" title="2.3.2 Definition Levels"></a>2.3.2 Definition Levels</h3><p><strong>Definition Level</strong> 表示路径上有多少可选字段被定义。嵌套数据类型的一个特点是，某些字段（例如可选字段或重复字段）可以为空，或者未被定义。如果一个字段被定义了，那么它的所有父节点也都必须是已定义的。从根节点开始遍历，当某个字段的路径上某个节点为空时，我们记录当前的深度作为该字段的 Definition Level。如果某字段的 Definition Level 达到了它的最大值，就说明该字段是有数据的。对于必须字段（如 required 类型），字段始终是定义的，因此 Definition Level 不需要特别标明。而对于可选字段（如 optional 类型），Definition Level 用于区分字段是未定义（为空）还是有值。在关系型数据中，Definition Level 为 0 表示字段未定义，1 或更高表示字段已定义并可能有值。</p>
<ol>
<li><strong>在 speeds 字段中</strong>：<ul>
<li>speeds 是一个列表字段，其元素是可选的。当列表中某个元素有值时，例如 12.5，它的 Definition Level 为 1，表示该元素被定义且有数据。</li>
<li>如果 speeds 列表为空，Definition Level 为 0，表示 speeds 未被定义。</li>
</ul>
</li>
<li><strong>在 trajectory 字段中</strong>：<ul>
<li>trajectory 是一个 Map 类型字段，键为时间戳，值为嵌套的纬度和经度字段。</li>
<li>当时间戳键值对中，纬度和经度都有值时，例如 latitude &#x3D; 40.7128 和 longitude &#x3D; -74.0060，Definition Level 为 2，表示字段完全定义且有值。</li>
<li>如果某个时间戳的纬度和经度值为空（例如 timestamp 为 2024-11-21 10:05:00 的键值对），Definition Level 会降为 1，表示字段已定义但没有数据。</li>
<li>如果整个 trajectory 字段为空，Definition Level 为 0，表示字段未被定义。</li>
</ul>
</li>
</ol>
<h3 id="2-3-3-计算过程"><a href="#2-3-3-计算过程" class="headerlink" title="2.3.3 计算过程"></a>2.3.3 计算过程</h3><p>以下是第一条和第二条数据的 Repetition Level (R) 和 Definition Level (D) 的计算过程整合：</p>
<p>对于第一条数据：</p>
<ul>
<li><strong>id</strong> 是标量字段，没有嵌套或重复，Repetition Level (R) 固定为 0，Definition Level (D) 固定为 0，表示字段始终定义并有值。</li>
<li><strong>speeds</strong> 是一个列表，第一个元素 12.5 表示列表的起点，因此 R&#x3D;0，D&#x3D;1；后续的 13.2 和 14.1 属于同一列表，因此 R&#x3D;1，D&#x3D;1，表明字段存在且有值。</li>
<li><strong>trajectory.timestamp</strong> 是Map的键，第一个键值对2024-11-21 10:00:00是 Map 的起点，R&#x3D;0，D&#x3D;2，表明键和值都定义且非空；第二个键值对2024-11-21 10:05:00是 Map 中的后续键值对，R&#x3D;1，D&#x3D;1，表明键已定义但值为空。</li>
<li><strong>trajectory.latitude</strong> 和 <strong>trajectory.longitude</strong> 是 Map 值中的嵌套字段，2024-11-21 10:00:00对应的纬度和经度都存在（由于是required字段，与上一层保持相同），因此 R&#x3D;0，D&#x3D;2；2024-11-21 10:05:00的纬度和经度为空，R&#x3D;1，D&#x3D;1，表示字段已定义但无值。</li>
</ul>
<p>对于第二条数据：</p>
<ul>
<li><strong>id</strong> 是标量字段，与第一条类似，Repetition Level (R) 固定为0，Definition Level (D) 固定为0。</li>
<li><strong>speeds</strong> 是一个列表，第一个元素 20.1 表示列表的起点，因此 R&#x3D;0，D&#x3D;1；后续的 21.3 属于同一列表，因此 R&#x3D;1，D&#x3D;1，表明字段存在且有值。</li>
<li><strong>trajectory.timestamp</strong> 是Map的键，只有一个键值对2024-11-21 11:00:00，因此 R&#x3D;0，D&#x3D;2，表明键和值都定义且非空。</li>
<li><strong>trajectory.latitude</strong> 和 <strong>trajectory.longitude</strong> 是 Map 值中的嵌套字段，2024-11-21 11:00:00对应的纬度和经度都存在，因此 R&#x3D;0，D&#x3D;2，表示字段已定义且有值。</li>
</ul>
<table>
<thead>
<tr>
<th><strong>Column</strong></th>
<th><strong>Value</strong></th>
<th><strong>R</strong></th>
<th><strong>D</strong></th>
<th><strong>Column</strong></th>
<th><strong>Value</strong></th>
<th><strong>R</strong></th>
<th><strong>D</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>id</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td><strong>trajectory.timestamp</strong></td>
<td>2024-11-21 10:00:00</td>
<td>0</td>
<td>2</td>
</tr>
<tr>
<td></td>
<td>2</td>
<td>0</td>
<td>0</td>
<td></td>
<td>2024-11-21 10:05:00</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><strong>speeds</strong></td>
<td>12.5</td>
<td>0</td>
<td>1</td>
<td></td>
<td>2024-11-21 11:00:00</td>
<td>0</td>
<td>2</td>
</tr>
<tr>
<td></td>
<td>13.2</td>
<td>1</td>
<td>1</td>
<td><strong>trajectory.latitude</strong></td>
<td>40.7128</td>
<td>0</td>
<td>2</td>
</tr>
<tr>
<td></td>
<td>14.1</td>
<td>1</td>
<td>1</td>
<td></td>
<td>NULL</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td></td>
<td>20.1</td>
<td>0</td>
<td>1</td>
<td></td>
<td>34.0522</td>
<td>0</td>
<td>2</td>
</tr>
<tr>
<td></td>
<td>21.3</td>
<td>1</td>
<td>1</td>
<td><strong>trajectory.longitude</strong></td>
<td>-74.0060</td>
<td>0</td>
<td>2</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>NULL</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>-118.2437</td>
<td>0</td>
<td>2</td>
</tr>
</tbody></table>
<h3 id="2-3-4-存储分析"><a href="#2-3-4-存储分析" class="headerlink" title="2.3.4 存储分析"></a>2.3.4 存储分析</h3><p>在Parquet中，所有字段会被展平为单独的列，每列存储其实际数据，同时附加R和D两列来记录层级结构和字段状态。Parquet并不存储NULL值，而是通过D的值来判断字段是否被定义。例如，Definition Level小于最大值时表示字段为空(NULL)。对于嵌套字段和重复字段（如MAP和LIST），R的值则用于区分新记录与同一结构中的后续值。</p>
<p>这种设计的优点在于，它可以在保持数据层级关系的同时，避免存储冗余的层级结构信息。同时，由于R和D只需要几位就可以表示字段的状态（如7层结构只需要3bit + 3bit 就能表示R和D），存储开销极小。空字段无需存储实际值，仅通过R和D即可高效表示。这种机制使得Parquet格式在处理嵌套数据时既保持了灵活性，又显著提升了存储和读取效率。</p>
<h2 id="2-4-编码与压缩技术"><a href="#2-4-编码与压缩技术" class="headerlink" title="2.4 编码与压缩技术"></a>2.4 编码与压缩技术</h2><h3 id="2-4-1-编码"><a href="#2-4-1-编码" class="headerlink" title="2.4.1 编码"></a>2.4.1 编码</h3><p>编码是将数据转换为更紧凑的格式，以减少存储空间或提高计算效率。Parquet 使用了几种常见的编码方式来对数据进行编码，这些编码方式有助于在存储时减少数据的冗余，提高读取性能。</p>
<ol>
<li><strong>PLAIN编码</strong>：PLAIN编码是Parquet中最基础的编码方式，它将原始数据直接存储，没有进行任何压缩或变换。该编码方式简单且高效，适用于数据分布均匀的场景，但可能会占用较多存储空间。PLAIN 编码通常用于存储不需要特别优化的字段数据，如简单的整数或字符串。</li>
<li><strong>DICTIONARY编码</strong>：DICTIONARY编码是一种通过使用字典（映射表）将数据中的重复值替换为字典索引的编码方式。该编码方法适用于有大量重复值的数据类型，比如类别型数据。在Parquet中，数据被分成多个区块，每个区块都会为该区块内的数据生成一个字典。存储时，数据中的重复项会被替换为字典的索引，进而节省存储空间。例如，如果一个字段中有多个相同的值，那么这些值将被映射为字典的索引，存储时只需保存索引而不是重复的值。这种方法能够显著降低存储空间，但需要为每个数据块生成字典，可能会增加读取时的解码开销。</li>
<li><strong>RLE（Run-Length Encoding）编码</strong>：RLE（Run-Length Encoding）编码是通过记录连续相同值的数量来压缩数据的一种方式。在数据中，若出现连续相同的值，RLE 会记录这些值出现的次数，从而将重复的数据压缩成更小的表示形式。RLE 编码特别适用于数据中存在大量连续相同值的情况。例如，如果一个字段连续出现 100 个相同的数字，那么 RLE 会将其压缩为“值+出现次数”的形式。在 Parquet 中，RLE 编码常用于布尔类型数据或者重复出现的数字类型数据。</li>
<li><strong>位打包（Bit-Packing）编码</strong>：位打包（Bit-Packing）是一种将多个小数据类型压缩为更小比特数表示的编码方式。该方法通过打包多个值来提高存储效率，通常用于存储较小的数据类型，如整数、布尔值等。Bit-Packing 可以将每个字段中的数据值压缩为最小的比特位数，从而减少存储空间。</li>
<li><strong>DELTA 编码</strong>：DELTA编码是一种记录数据与其前一个值差异的编码方式。这种方法非常适合存储数值范围比较小且增减变化不大的数据。例如，对于一个增长规律较为平稳的数字序列，DELTA 编码将存储每个数值与前一个数值的差异，而不是存储完整的数值。这样可以显著降低存储空间，特别是对于时间序列数据或连续数据。</li>
</ol>
<h3 id="2-4-2-压缩"><a href="#2-4-2-压缩" class="headerlink" title="2.4.2 压缩"></a>2.4.2 压缩</h3><p>压缩是将数据进一步减少存储空间的技术。Parquet支持多种压缩算法，可以在不牺牲数据质量的情况下，进一步压缩数据以节省存储空间。常见的压缩算法包括Snappy、GZIP、LZO、Brotli等。</p>
<ol>
<li>Snappy压缩：Snappy 是 Google 开发的一种压缩算法，具有非常快的压缩和解压缩速度。它的压缩比虽然不如 GZIP，但由于其高效的速度，特别适合大数据处理场景中实时数据处理的需求。Snappy 通常是 Parquet 默认的压缩算法，尤其适用于对速度要求较高的场景。</li>
<li>GZIP压缩：GZIP是一种较为常见的压缩算法，相较于Snappy，它的压缩比更高，但速度较慢。GZIP压缩适用于对存储空间有较高要求的场景，尤其是当存储成本较高或数据量特别大的时候。GZIP的高压缩比使得它能有效减少存储需求，但解压缩的速度可能成为瓶颈。</li>
<li>LZO压缩：LZO是一种快速的压缩算法，类似于Snappy，适用于需要快速压缩和解压缩的场景。LZO的压缩比一般不如GZIP，但它的速度非常快，适合于大数据分析中对压缩速度要求较高的应用场景。</li>
<li>Brotli压缩：Brotli 是由Google开发的一种压缩算法，常用于Web数据传输中的压缩。Brotli的压缩比比GZIP更高，并且其解压速度也较为高效。近年来，Brotli也开始在Parquet中被使用，尤其适用于对存储需求有较高要求的场景。</li>
<li>Zstandard（ZSTD）压缩：Zstandard（ZSTD）是一种新兴的压缩算法，旨在提供比 GZIP 更高的压缩比和更快的解压速度。ZSTD 兼具了较高的压缩效率和较低的延迟，非常适合需要平衡存储与速度的应用场景。</li>
</ol>
<h1 id="3-Parquet具体实现"><a href="#3-Parquet具体实现" class="headerlink" title="3. Parquet具体实现"></a>3. Parquet具体实现</h1><h2 id="3-1-Parquet-文件存储格式中的术语"><a href="#3-1-Parquet-文件存储格式中的术语" class="headerlink" title="3.1 Parquet 文件存储格式中的术语"></a>3.1 Parquet 文件存储格式中的术语</h2><p>在理解 Parquet 文件的存储结构时，熟悉其中关键术语至关重要。以下是 Parquet 中一些核心术语的定义：</p>
<ul>
<li>**Block (HDFS 块)**：这是 Hadoop 分布式文件系统（HDFS）中数据存储的基本单元，Parquet 文件完全兼容 HDFS 的设计。Block 的大小在 Hadoop 1.x 版本中默认为 64MB，而在 Hadoop 2.x 版本中则增加至 128MB。HDFS 使用 Block 的副本机制来确保数据的冗余和容错能力，从而提高了系统的可靠性和稳定性。</li>
<li>**File (文件)**：这是存储在 HDFS 上的一个逻辑实体，包含文件的元数据信息，但其实际数据内容由多个 HDFS Block 保存。</li>
<li>**Row Group (行组)**：Parquet 将数据按行划分为多个逻辑上的水平分区。每个 Row Group 包含该组中所有列的列块（Column Chunk），是并行化和 IO 操作的基本单元。这样设计使得每个行组都可以独立解码，便于分布式处理。</li>
<li>**Column Chunk (列块)**：指单列数据在一个行组中的物理存储。列块在行组中是逻辑连续的，这种设计允许对列进行有效的压缩和编码，从而提高了存储的利用率。</li>
<li>**Page (页面)**：列块被进一步划分为多个 Page，这是 Parquet 文件压缩和编码的最小基本单元。每个列块中可能包含多个类型的 Page，例如数据页面、字典页面等。</li>
</ul>
<div style="text-align: center;">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/images/format.png" style="width:66%;"/>
</div>

<h2 id="3-2-并行化执行的基本单元"><a href="#3-2-并行化执行的基本单元" class="headerlink" title="3.2 并行化执行的基本单元"></a>3.2 并行化执行的基本单元</h2><p>在 Parquet 文件中，不同层级的数据单元在并行化处理和 IO 操作中发挥不同的作用：</p>
<ul>
<li><p><strong>MapReduce 任务划分</strong>：在使用 Hadoop 的 MapReduce 框架处理数据时，通常以 File 或 Row Group 为基本单位来分配任务，即每个任务处理一个完整的文件或者一个行组，从而实现并行化。</p>
</li>
<li><p><strong>IO 操作</strong>：Parquet 文件的 IO 操作以 Column Chunk 为基本单位进行。这种设计方式使得可以只读取所需列的数据，减少不必要的磁盘 IO，从而提高读取效率。</p>
</li>
<li><p><strong>编码和压缩</strong>：在 Parquet 中，编码和压缩通常以 Page 为单位进行。每个页面可以使用不同的编码方法来提高压缩率，例如使用 RLE（Run Length Encoding）对重复值进行压缩，从而降低存储空间。</p>
</li>
</ul>
<h2 id="3-3-Parquet-文件格式"><a href="#3-3-Parquet-文件格式" class="headerlink" title="3.3 Parquet 文件格式"></a>3.3 Parquet 文件格式</h2><p>Parquet 文件格式具有自解析的特性，文件使用 Thrift 格式定义 schema 以及其他元数据信息。这些元数据信息存储在文件末尾，方便读取时直接访问。</p>
<p>典型的 Parquet 文件结构如下：</p>
<ul>
<li>整个文件被划分为多个行组，每个行组包含所有列的数据块和元数据信息。</li>
<li>文件的元数据存储在数据部分的最后，包含了所有列块元数据的起始位置。</li>
</ul>
<p>这种将元数据存储在文件末尾的设计，使得在写入数据时可以顺序高效地写入文件，同时在读取文件时可以快速获取元数据并定位到相关数据块。</p>
<h2 id="3-4-元数据信息"><a href="#3-4-元数据信息" class="headerlink" title="3.4 元数据信息"></a>3.4 元数据信息</h2><p>Parquet 文件包含三种不同类型的元数据，每种元数据在不同层级描述文件的内容和结构：</p>
<ul>
<li><strong>文件元数据</strong>：描述整个文件的结构和内容，例如行组和列块的位置信息等，是文件级别的数据概览。</li>
<li><strong>列（块）元数据</strong>：描述单个列块的详细信息，包括该列块的属性、位置和大小。这些元数据使得读取特定列块变得更加高效。</li>
<li><strong>页面头部元数据</strong>：描述每个页面的具体属性，包括编码方式、压缩方法、页面位置等。这些元数据对于解码和读取页面中的数据至关重要。</li>
</ul>
<div style="text-align: center;">
  <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/images/metadata.png" style="width:66%;"/>
</div>

<h2 id="3-5-并行读取与列存储的优化"><a href="#3-5-并行读取与列存储的优化" class="headerlink" title="3.5 并行读取与列存储的优化"></a>3.5 并行读取与列存储的优化</h2><p>Parquet 的设计充分考虑了并行处理和列存储的优势。由于数据是按列存储的，因此可以非常高效地进行列的读取操作。尤其是对于只需要部分列的查询，Parquet 能够显著减少 IO 开销，提升性能。每个行组中的列块在物理上保持连续存储，这样即使是大规模并行读取也可以最大程度减少磁盘寻道时间。</p>
<h2 id="3-6-编码（Encoding）"><a href="#3-6-编码（Encoding）" class="headerlink" title="3.6 编码（Encoding）"></a>3.6 编码（Encoding）</h2><p>Parquet 支持多种编码方式，以优化数据的压缩和读取效率。细节可以参考官方文档：<a target="_blank" rel="noopener" href="https://github.com/apache/parquet-format/blob/master/Encodings.md">Parquet Encodings</a>。通过采用不同的编码方法，Parquet 能够大幅度减少重复值存储，从而节省磁盘空间。</p>
<h2 id="3-7-Column-Chunks-存储与读取"><a href="#3-7-Column-Chunks-存储与读取" class="headerlink" title="3.7 Column Chunks 存储与读取"></a>3.7 Column Chunks 存储与读取</h2><p>每个 Column Chunk 是由多个 Page 组成的。在读取数据时，Parquet Reader 可以利用页面头部元数据中存储的信息，直接跳过不感兴趣的页面。例如，字典页面与数据页面存储的内容类型不同，Reader 可以根据需求决定是否需要加载某些页面，从而优化查询性能。</p>
<h2 id="3-8-错误处理机制"><a href="#3-8-错误处理机制" class="headerlink" title="3.8 错误处理机制"></a>3.8 错误处理机制</h2><p>Parquet 文件设计了一系列机制来应对数据损坏的情况，以保证数据的可用性和可靠性：</p>
<ul>
<li><strong>文件元数据损坏</strong>：如果整个文件的元数据损坏，通常情况下整个文件会无法读取。</li>
<li><strong>列元数据损坏</strong>：如果某个列的元数据损坏，只会影响该列块的读取，其他行组中相同列的块仍可正常使用，这种设计能够减少局部损坏对整体数据的影响。</li>
<li><strong>页面头部损坏</strong>：当页面头部损坏时，该列块中的所有后续页面将无法读取。</li>
<li><strong>页面数据损坏</strong>：如果某个页面的数据损坏，通常只会导致该页面的数据不可用，其它页面的数据仍然可用。</li>
</ul>
<p>较小的行组设置可以更好地抵抗数据损坏，因为损坏只会影响较小的数据范围，而不会影响整个文件。</p>
<h2 id="3-9-推荐的配置参数"><a href="#3-9-推荐的配置参数" class="headerlink" title="3.9 推荐的配置参数"></a>3.9 推荐的配置参数</h2><p>为了实现最佳的性能和可靠性，Parquet 提供了一些推荐配置：</p>
<ul>
<li><p><strong>行组大小（Row group size）</strong>：较大的行组可以使列块变得更大，进而提升顺序 IO 的性能。虽然较大的行组需要更多的内存缓存，但它能够有效减少 IO 操作次数，从而提升性能。Parquet 推荐的行组大小为 512MB 至 1GB。此外，行组最好与 HDFS 的 Block 大小对齐，以减少跨 Block 的 IO 操作。理想的配置是行组大小和 HDFS Block 大小均为 1GB，并保证每个 HDFS 文件对应一个 HDFS Block。</p>
</li>
<li><p><strong>数据页大小（Data page size）</strong>：数据页是不可分割的存储单元。较小的数据页允许更精细的随机访问（如单行查找），但会增加 page header 的数量，从而带来空间开销。较大的数据页可以降低页面头部的开销，提升数据解析的效率。Parquet 推荐的数据页大小为 8KB，以在性能与空间利用率之间取得平衡。</p>
</li>
</ul>
<p>总结来看，Parquet 文件格式通过行组、列块、页面三级结构，结合丰富的元数据信息和多种编码方式，达到了高效的数据存储和读取性能。其列式存储特性使得数据的压缩率大幅提高，并能高效支持大规模的并行查询。对于需要处理海量数据的场景，Parquet 是一种高效而可靠的数据存储格式。</p>
<h1 id="4-Python使用Parquet"><a href="#4-Python使用Parquet" class="headerlink" title="4. Python使用Parquet"></a>4. Python使用Parquet</h1><h2 id="4-1-安装依赖并导入"><a href="#4-1-安装依赖并导入" class="headerlink" title="4.1 安装依赖并导入"></a>4.1 安装依赖并导入</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyarrow pandas</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pyarrow <span class="keyword">as</span> pa</span><br><span class="line"><span class="keyword">import</span> pyarrow.parquet <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br></pre></td></tr></table></figure>
<h2 id="4-2-定义schema"><a href="#4-2-定义schema" class="headerlink" title="4.2 定义schema"></a>4.2 定义schema</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">schema = pa.schema([</span><br><span class="line">    (<span class="string">&quot;id&quot;</span>, pa.int32()),</span><br><span class="line">    (<span class="string">&quot;speeds&quot;</span>, pa.list_(pa.float64())),</span><br><span class="line">    (<span class="string">&quot;trajectory&quot;</span>, pa.map_(</span><br><span class="line">        pa.timestamp(<span class="string">&#x27;ms&#x27;</span>),  </span><br><span class="line">        pa.struct([   </span><br><span class="line">            (<span class="string">&quot;latitude&quot;</span>, pa.float64()),</span><br><span class="line">            (<span class="string">&quot;longitude&quot;</span>, pa.float64())</span><br><span class="line">        ])</span><br><span class="line">    ))</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<h2 id="4-3-导入数据"><a href="#4-3-导入数据" class="headerlink" title="4.3 导入数据"></a>4.3 导入数据</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">data = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;speeds&quot;</span>: [<span class="number">12.5</span>, <span class="number">13.2</span>, <span class="number">14.1</span>],</span><br><span class="line">        <span class="string">&quot;trajectory&quot;</span>: &#123;</span><br><span class="line">            datetime(<span class="number">2024</span>, <span class="number">11</span>, <span class="number">21</span>, <span class="number">10</span>, <span class="number">0</span>): &#123;<span class="string">&quot;latitude&quot;</span>: <span class="number">40.7128</span>, <span class="string">&quot;longitude&quot;</span>: -<span class="number">74.0060</span>&#125;,</span><br><span class="line">            datetime(<span class="number">2024</span>, <span class="number">11</span>, <span class="number">21</span>, <span class="number">10</span>, <span class="number">5</span>): <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;speeds&quot;</span>: [<span class="number">20.1</span>, <span class="number">21.3</span>],</span><br><span class="line">        <span class="string">&quot;trajectory&quot;</span>: &#123;</span><br><span class="line">            datetime(<span class="number">2024</span>, <span class="number">11</span>, <span class="number">21</span>, <span class="number">11</span>, <span class="number">0</span>): &#123;<span class="string">&quot;latitude&quot;</span>: <span class="number">34.0522</span>, <span class="string">&quot;longitude&quot;</span>: -<span class="number">118.2437</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">df = pd.DataFrame(data)</span><br></pre></td></tr></table></figure>
<h2 id="4-4-生成parquet文件"><a href="#4-4-生成parquet文件" class="headerlink" title="4.4 生成parquet文件"></a>4.4 生成parquet文件</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compression_method = <span class="string">&#x27;gzip&#x27;</span> <span class="comment">#(snappy、lzo、brotli ...)</span></span><br><span class="line">table = pa.Table.from_pandas(df, schema=schema)</span><br><span class="line">pq.write_table(table, <span class="string">&quot;example.parquet&quot;</span>, compression_method)</span><br></pre></td></tr></table></figure>

<h2 id="4-4读取parquet文件并且查看格式信息"><a href="#4-4读取parquet文件并且查看格式信息" class="headerlink" title="4.4读取parquet文件并且查看格式信息"></a>4.4读取parquet文件并且查看格式信息</h2><h3 id="4-4-1-读取parquet文件"><a href="#4-4-1-读取parquet文件" class="headerlink" title="4.4.1 读取parquet文件"></a>4.4.1 读取parquet文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read_table = pq.read_table(<span class="string">&quot;exmaple.parquet&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(read_table.to_pandas())</span><br></pre></td></tr></table></figure>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  id        speeds                                         trajectory</span><br><span class="line">0   1  [45.5, 60.2]  [&#123;&#x27;key&#x27;: 2024-11-21 10:30:00, &#x27;value&#x27;: &#123;&#x27;latit...</span><br><span class="line">1   2  [35.2, 50.0]  [&#123;&#x27;key&#x27;: 2024-11-21 11:00:00, &#x27;value&#x27;: &#123;&#x27;latit...</span><br></pre></td></tr></table></figure>

<h3 id="4-4-2-查看schame-元信息"><a href="#4-4-2-查看schame-元信息" class="headerlink" title="4.4.2 查看schame&amp;元信息"></a>4.4.2 查看schame&amp;元信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">parquet_file = pq.ParquetFile(<span class="string">&quot;example&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;元信息：&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(parquet_file.metadata)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nSchema：&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(parquet_file.schema)</span><br></pre></td></tr></table></figure>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> 元信息：</span><br><span class="line">&lt;pyarrow._parquet.FileMetaData object at 0x000002019E93A980&gt;</span><br><span class="line">  created_by: parquet-cpp-arrow version 18.0.0-SNAPSHOT</span><br><span class="line">  num_columns: 5</span><br><span class="line">  num_rows: 2</span><br><span class="line">  num_row_groups: 1</span><br><span class="line">  format_version: 2.6</span><br><span class="line">  serialized_size: 3014</span><br><span class="line"></span><br><span class="line">Schema：</span><br><span class="line">&lt;pyarrow._parquet.ParquetSchema object at 0x000002019E9F0A40&gt;</span><br><span class="line">required group field_id=-1 schema &#123;</span><br><span class="line">  optional int32 field_id=-1 id;</span><br><span class="line">  optional group field_id=-1 speeds (List) &#123;</span><br><span class="line">    repeated group field_id=-1 list &#123;</span><br><span class="line">      optional double field_id=-1 element;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  optional group field_id=-1 trajectory (Map) &#123;</span><br><span class="line">    repeated group field_id=-1 key_value &#123;</span><br><span class="line">      required int64 field_id=-1 key (Timestamp(isAdjustedToUTC=false, timeUnit=milliseconds, is_from_converted_type=false, force_set_converted_type=false));</span><br><span class="line">      optional group field_id=-1 value &#123;</span><br><span class="line">        optional double field_id=-1 latitude;</span><br><span class="line">        optional double field_id=-1 longitude;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-3-查看列信息"><a href="#4-4-3-查看列信息" class="headerlink" title="4.4.3 查看列信息"></a>4.4.3 查看列信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">row_group = parquet_file.metadata.row_group(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> col_idx <span class="keyword">in</span> <span class="built_in">range</span>(parquet_file.metadata.num_columns):</span><br><span class="line">    column = row_group.column(col_idx)</span><br><span class="line">    column_name = parquet_file.schema.column(col_idx).name</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;列 <span class="subst">&#123;col_idx&#125;</span> (<span class="subst">&#123;column_name&#125;</span>) 信息：&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  总值数量：<span class="subst">&#123;column.num_values&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  压缩大小：<span class="subst">&#123;column.total_compressed_size&#125;</span> 字节&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  未压缩大小：<span class="subst">&#123;column.total_uncompressed_size&#125;</span> 字节&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  最大值：<span class="subst">&#123;column.statistics.<span class="built_in">max</span> <span class="keyword">if</span> column.statistics <span class="keyword">else</span> <span class="string">&#x27;无统计信息&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  最小值：<span class="subst">&#123;column.statistics.<span class="built_in">min</span> <span class="keyword">if</span> column.statistics <span class="keyword">else</span> <span class="string">&#x27;无统计信息&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  空值数量：<span class="subst">&#123;column.statistics.null_count <span class="keyword">if</span> column.statistics <span class="keyword">else</span> <span class="string">&#x27;无统计信息&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;---&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">  列 0 (id) 信息：</span><br><span class="line">  总值数量：2</span><br><span class="line">  压缩大小：80 字节</span><br><span class="line">  未压缩大小：76 字节</span><br><span class="line">  最大值：2</span><br><span class="line">  最小值：1</span><br><span class="line">  空值数量：0</span><br><span class="line">---</span><br><span class="line">列 1 (element) 信息：</span><br><span class="line">  总值数量：5</span><br><span class="line">  压缩大小：130 字节</span><br><span class="line">  未压缩大小：132 字节</span><br><span class="line">  最大值：21.3</span><br><span class="line">  最小值：12.5</span><br><span class="line">  空值数量：0</span><br><span class="line">---</span><br><span class="line">列 2 (key) 信息：</span><br><span class="line">  总值数量：3</span><br><span class="line">  压缩大小：119 字节</span><br><span class="line">  未压缩大小：115 字节</span><br><span class="line">  最大值：2024-11-21 11:00:00</span><br><span class="line">  最小值：2024-11-21 10:00:00</span><br><span class="line">  空值数量：0</span><br><span class="line">---</span><br><span class="line">列 3 (latitude) 信息：</span><br><span class="line">  总值数量：3</span><br><span class="line">  压缩大小：119 字节</span><br><span class="line">  未压缩大小：115 字节</span><br><span class="line">  最大值：40.7138</span><br><span class="line">  最小值：34.0522</span><br><span class="line">  空值数量：0</span><br><span class="line">---</span><br><span class="line">列 4 (longitude) 信息：</span><br><span class="line">  总值数量：3</span><br><span class="line">  压缩大小：119 字节</span><br><span class="line">  未压缩大小：115 字节</span><br><span class="line">  最大值：-74.006</span><br><span class="line">  最小值：-118.2437</span><br><span class="line">  空值数量：0</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h3 id="4-4-4-查看列编码方式"><a href="#4-4-4-查看列编码方式" class="headerlink" title="4.4.4 查看列编码方式"></a>4.4.4 查看列编码方式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> col_idx <span class="keyword">in</span> <span class="built_in">range</span>(parquet_file.metadata.num_columns):</span><br><span class="line">    column_encoding = parquet_file.metadata.row_group(<span class="number">0</span>).column(col_idx).encodings</span><br><span class="line">    column_name = parquet_file.schema.column(col_idx).name</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;列 <span class="subst">&#123;col_idx&#125;</span> (<span class="subst">&#123;column_name&#125;</span>) 编码方式：&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Encodings: <span class="subst">&#123;column_encoding&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;---&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">列 0 (id) 编码方式：</span><br><span class="line">  Encodings: (&#x27;PLAIN&#x27;, &#x27;RLE&#x27;, &#x27;RLE_DICTIONARY&#x27;)</span><br><span class="line">---</span><br><span class="line">列 1 (element) 编码方式：</span><br><span class="line">  Encodings: (&#x27;PLAIN&#x27;, &#x27;RLE&#x27;, &#x27;RLE_DICTIONARY&#x27;)</span><br><span class="line">---</span><br><span class="line">列 2 (key) 编码方式：</span><br><span class="line">  Encodings: (&#x27;PLAIN&#x27;, &#x27;RLE&#x27;, &#x27;RLE_DICTIONARY&#x27;)</span><br><span class="line">---</span><br><span class="line">列 3 (latitude) 编码方式：</span><br><span class="line">  Encodings: (&#x27;PLAIN&#x27;, &#x27;RLE&#x27;, &#x27;RLE_DICTIONARY&#x27;)</span><br><span class="line">---</span><br><span class="line">列 4 (longitude) 编码方式：</span><br><span class="line">  Encodings: (&#x27;PLAIN&#x27;, &#x27;RLE&#x27;, &#x27;RLE_DICTIONARY&#x27;)</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h1><p>本文详细介绍了 Apache Parquet 格式的原理与实践，重点讲解了其列式存储结构、嵌套数据支持、编码与压缩技术、以及如何在 Python 中使用 Parquet 文件。Parquet 的设计充分利用了列式存储的优势，特别是在大数据分析场景中，它能够显著提高查询效率并有效节省存储空间。</p>
<ol>
<li><p><strong>列式存储优势</strong>：Parquet 的列式存储方式使得在进行数据分析时，可以只读取所需的列，减少了不必要的磁盘 I&#x2F;O 操作。此外，列式存储能高效地压缩数据，特别是对于重复性高的数据，能够显著减少存储空间的占用。</p>
</li>
<li><p><strong>复杂嵌套结构支持</strong>：通过使用 Repetition Levels 和 Definition Levels，Parquet 能够高效处理复杂的嵌套数据结构，例如 List 和 Map。这种设计让 Parquet 格式在处理包含多个嵌套字段的复杂数据时，保持高效且灵活。</p>
</li>
<li><p><strong>编码与压缩技术</strong>：Parquet 支持多种编码方式（如 PLAIN、DICTIONARY、RLE 编码等）和压缩算法（如 Snappy、GZIP、LZO 等）。这些技术帮助优化存储空间并提升数据读取性能。在不同的场景下，用户可以选择适合的编码和压缩方法，以平衡存储与速度的需求。</p>
</li>
<li><p><strong>Python 使用 Parquet</strong>：通过 <code>pyarrow</code> 库，Python 用户能够轻松地创建、读取和操作 Parquet 文件。示例代码展示了如何定义 Parquet 文件的 schema、将数据导入并生成 Parquet 文件，以及如何读取 Parquet 文件并查看其元数据和编码信息。</p>
</li>
<li><p><strong>性能优化</strong>：Parquet 的设计考虑了并行处理，支持高效的列读取操作，这对于大规模数据处理非常重要。它通过将数据划分为行组（Row Groups）、列块（Column Chunks）和页面（Pages），使得分布式计算框架如 Hadoop 和 Spark 能够高效地处理数据。</p>
</li>
</ol>
<p>总的来说，Parquet 是一种功能强大的数据存储格式，它结合了列式存储的优势与高效的压缩、编码技术，特别适合用于大数据分析和大规模分布式计算环境中。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/blog/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/49890814.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/49890814.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">孙杨洋</div><div class="post-copyright__author_desc">看就完了</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://yangysun.github.io/blog/2024/11/18/Parquet/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://yangysun.github.io/blog/2024/11/18/Parquet/')">Parquet原理详解</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://yangysun.github.io/blog/2024/11/18/Parquet/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Parquet原理详解&amp;url=https://yangysun.github.io/blog/2024/11/18/Parquet/&amp;pic=/blog/images/cover_image/parquet.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yangysun.github.io/blog" target="_blank">孙氏杂货铺</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/blog/tags/parquet/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>parquet<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/blog/tags/%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>文件存储<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/blog/images/cover_image/parquet.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/blog/2024/11/12/%E4%BD%BF%E7%94%A8Python%E6%8F%90%E5%8F%96%E5%9F%8E%E5%B8%82%E8%B7%AF%E7%BD%91/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/img/roadNetwork.png" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">使用Python提取城市路网</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/blog/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/49890814.jpg" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/blog/"><h1 class="author-info__name">孙杨洋</h1><div class="author-info__desc">看就完了</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/YangySun" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">1. 基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8-VS-%E8%A1%8C%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 列式存储 VS 行式存储</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Parquet%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.</span> <span class="toc-text">2. Parquet详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 数据模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 列式存储格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Repetition-and-Definition-Levels"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Repetition and Definition Levels</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-Repetition-Levels"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 Repetition Levels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-Definition-Levels"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 Definition Levels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E8%AE%A1%E7%AE%97%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 计算过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90"><span class="toc-number">2.3.4.</span> <span class="toc-text">2.3.4 存储分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E7%BC%96%E7%A0%81%E4%B8%8E%E5%8E%8B%E7%BC%A9%E6%8A%80%E6%9C%AF"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 编码与压缩技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-%E7%BC%96%E7%A0%81"><span class="toc-number">2.4.1.</span> <span class="toc-text">2.4.1 编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-%E5%8E%8B%E7%BC%A9"><span class="toc-number">2.4.2.</span> <span class="toc-text">2.4.2 压缩</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Parquet%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">3. Parquet具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Parquet-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%A0%BC%E5%BC%8F%E4%B8%AD%E7%9A%84%E6%9C%AF%E8%AF%AD"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 Parquet 文件存储格式中的术语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%B9%B6%E8%A1%8C%E5%8C%96%E6%89%A7%E8%A1%8C%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8D%95%E5%85%83"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 并行化执行的基本单元</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Parquet-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Parquet 文件格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%85%83%E6%95%B0%E6%8D%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 元数据信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E5%B9%B6%E8%A1%8C%E8%AF%BB%E5%8F%96%E4%B8%8E%E5%88%97%E5%AD%98%E5%82%A8%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 并行读取与列存储的优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-%E7%BC%96%E7%A0%81%EF%BC%88Encoding%EF%BC%89"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 编码（Encoding）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-Column-Chunks-%E5%AD%98%E5%82%A8%E4%B8%8E%E8%AF%BB%E5%8F%96"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 Column Chunks 存储与读取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-number">3.8.</span> <span class="toc-text">3.8 错误处理机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-%E6%8E%A8%E8%8D%90%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="toc-number">3.9.</span> <span class="toc-text">3.9 推荐的配置参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Python%E4%BD%BF%E7%94%A8Parquet"><span class="toc-number">4.</span> <span class="toc-text">4. Python使用Parquet</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%B9%B6%E5%AF%BC%E5%85%A5"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 安装依赖并导入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%AE%9A%E4%B9%89schema"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 定义schema</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 导入数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E7%94%9F%E6%88%90parquet%E6%96%87%E4%BB%B6"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 生成parquet文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4%E8%AF%BB%E5%8F%96parquet%E6%96%87%E4%BB%B6%E5%B9%B6%E4%B8%94%E6%9F%A5%E7%9C%8B%E6%A0%BC%E5%BC%8F%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.</span> <span class="toc-text">4.4读取parquet文件并且查看格式信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-%E8%AF%BB%E5%8F%96parquet%E6%96%87%E4%BB%B6"><span class="toc-number">4.5.1.</span> <span class="toc-text">4.4.1 读取parquet文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E6%9F%A5%E7%9C%8Bschame-%E5%85%83%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.2.</span> <span class="toc-text">4.4.2 查看schame&amp;元信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E6%9F%A5%E7%9C%8B%E5%88%97%E4%BF%A1%E6%81%AF"><span class="toc-number">4.5.3.</span> <span class="toc-text">4.4.3 查看列信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-4-%E6%9F%A5%E7%9C%8B%E5%88%97%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F"><span class="toc-number">4.5.4.</span> <span class="toc-text">4.4.4 查看列编码方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">5. 总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog/2024/11/18/Parquet/" title="Parquet原理详解"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/images/cover_image/parquet.jpg" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="Parquet原理详解"/></a><div class="content"><a class="title" href="/blog/2024/11/18/Parquet/" title="Parquet原理详解">Parquet原理详解</a><time datetime="2024-11-18T10:26:54.000Z" title="发表于 2024-11-18 10:26:54">2024-11-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog/2024/11/12/%E4%BD%BF%E7%94%A8Python%E6%8F%90%E5%8F%96%E5%9F%8E%E5%B8%82%E8%B7%AF%E7%BD%91/" title="使用Python提取城市路网"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/img/roadNetwork.png" onerror="this.onerror=null;this.src='/blog/img/404.jpg'" alt="使用Python提取城市路网"/></a><div class="content"><a class="title" href="/blog/2024/11/12/%E4%BD%BF%E7%94%A8Python%E6%8F%90%E5%8F%96%E5%9F%8E%E5%B8%82%E8%B7%AF%E7%BD%91/" title="使用Python提取城市路网">使用Python提取城市路网</a><time datetime="2024-11-12T11:10:45.000Z" title="发表于 2024-11-12 11:10:45">2024-11-12</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:775959301@qq.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" href="/blog/null" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" href="/blog/null" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><a class="deal_link" href="/blog/null" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/blog/49890814.jpg" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/YangySun" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" href="/blog/null" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" href="/blog/null" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a><a class="deal_link" href="/blog/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"/></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2024 By <a class="footer-bar-link" href="/blog/" title="孙杨洋" target="_blank">孙杨洋</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/blog/archives/" title="archive"><div class="headline">文章</div><div class="length-num">2</div></a><a href="/blog/tags/" title="tag"><div class="headline">标签</div><div class="length-num">4</div></a><a href="/blog/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="1"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="1"/><span class="back-menu-item-text">1</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="2"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="2"/><span class="back-menu-item-text">2</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/blog/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/blog/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/blog/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/blog/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/blog/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/blog/tags/Python/" style="font-size: 0.88rem;">Python<sup>1</sup></a><a href="/blog/tags/parquet/" style="font-size: 0.88rem;">parquet<sup>1</sup></a><a href="/blog/tags/%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/" style="font-size: 0.88rem;">文件存储<sup>1</sup></a><a href="/blog/tags/%E8%B7%AF%E7%BD%91/" style="font-size: 0.88rem;">路网<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="/blog/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("11/11/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 孙杨洋 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline-kappa-two.vercel.app/',
      pageview: true,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: false,
      imageUploader: true,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    anzhiyu.addGlobalFn('pjax', destroyWaline, 'destroyWaline')
  }

  const loadWaline = async () => {
    if (initFn) initWaline(initFn)
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.css')
      if (false) await getCSS('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline-meta.css')
      const { init } = await import('https://cdn.cbd.int/@waline/client@3.1.3/dist/waline.js')
      initFn = init || Waline.init
      initWaline(initFn)
      window.walineFn = initFn
    }
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = content => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = async () => {
    try {
      const res = await fetch('https://waline-kappa-two.vercel.app/api/comment?type=recent&count=6', { method: 'GET' })
      const result = await res.json()
      const walineArray = result.data.map(e => {
        return {
          'content': changeContent(e.comment),
          'avatar': e.avatar,
          'nick': e.nick,
          'url': e.url + '#' + e.objectId,
          'date': e.time || e.insertedAt
        }
      })
      saveToLocal.set('waline-newest-comments', JSON.stringify(walineArray), 10/(60*24))
      generateHtml(walineArray)
    } catch (err) {
      console.error(err)
      const $dom = document.querySelector('#card-newest-comments .aside-list')
      $dom.textContent= "无法获取评论，请确认相关配置是否正确"
    }
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('waline-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/blog/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>